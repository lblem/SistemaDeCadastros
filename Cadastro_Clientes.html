<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="StyleCadastroClientes.css" />
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/7023/7023905.png "> <!--icone da página / aba browser-->
    <title>Cadastro de Cliente</title> <!--Título da página / aba-->
</head>

<body>
    <div id="area">
        <form id="cadastro" autocomplete="off"> 
            <fieldset>
                <img class="gnc_img" src="https://cdn-icons-png.flaticon.com/512/7023/7023905.png">
                <legend>Cadastro de Cliente</legend>
                    
                    <label>* Id:</label>
                    <input id="field_id" class="campo_id" type="text" name="Id"><br/><br> <!--campo id-->
                    
                    <label>* Nome:</label>
                    <input onfocus="this.value='';" id="field_nome" class="campo_nome" type="text" name="nome"><br><br> <!--campo nome-->

                    <label>* CPF:</label>
                    <input id="field_cpf" class="campo_cpf" type="tel" name="cpf" placeholder="000.000.000-00" maxlength="11"> <!--campo CPF-->
                    <br><br>

                    <label class="label_sexo">* Sexo:</label> <!--campo sexo (select options)-->
                    <select id="field_sexo" class="campo_sexo">
                    </select>

                    <label class="label_data">* Data Nasc:</label> <!--campo data de nascimento (date)-->
                    <input id="field_data" class="campo_data" type="date">

                    <label for="field_endereco" class="label_endereco">* Endereço:</label> <!--campo CEP (txt)-->
                    <input id="field_endereco" class="campo_endereco" type="text" placeholder="Ex: Rua, n°, Bairro" required> 

                    <label class="label_cidade">* Cidade:</label> <!--campo cidade (pega as cidades cadastradas no Cadastro_Cidades e recupera os valores da Localstorage-->
                    <select id="field_cidade" class="campo_cidade">
                        </select>
                    <br><br>
                    <button class="btn_fechar" onclick="window.close()">X</button> <!--função nativa para fechar aba do navegador [Botão de sair e X]-->

                <button type="button" class="btn inserir" id="btnAddLine"  onclick="insertItem()">Inserir</button> <!--Botão inserir-->
                <button type="button" onclick="updateItem()">Alterar</button> <!--Botão alterar-->
                <button type="button" class="btn excluir" onclick="deleteItem()">Excluir</button> <!--Botão excluir-->
                <a type="button" href="HomePage.html">Cancelar</a> <!--Botão cancelar com direcionamento para a HomePage-->
                <br>
                <br>
                <br>

                <section id="tableWrapper"> <!--Cabeçalho da tabela, referenciado pro script entender onde inicia a tabela-->
                </section>

                <table id="tabelaDados"> <!--criação da tabela-->
                    <thead>
                        <tr>
                            <th><input class="filtro_table" placeholder="Buscar cliente pelo nome" type="text" id="search"/></th> <!--Filtro de busca pelo nome do cliente-->
                    </tr>    
                    </thead>
                </table>
            </fieldset>
        </form>
    </div>

    <script>

        let newId = 0 //inicio da contagem do id, iniciando de 0 + 1 = 1, 2, 3...
        let selectedItem = undefined
        // array com os TD's estáticos
        const thArray = [{ class: 'table_id', label: 'Id' }, { class: 'table_nome', label: 'Nome' }, { class: 'table_cpf', label: 'CPF' }, { class: 'table_data', label: 'Data Nasc.'}, { class: 'table_sexo', label: 'Sexo'}, { class: 'table_endereco', label: 'Endereço'}, { class: 'table_Cidade', label: 'Cidade'}]
        // esses dados serão dinamicos, inseridos pelo usuário nos campos de id, nome, cpf, data, cidade e endereço
        let trArray = []
        // array das opções do field select do campo sexo
        const selectFieldOptions = [
            { value: 'Masculino', label: 'Masculino' },
            { value: 'feminino', label: 'Feminino' },
            { value: 'Outro', label: 'Outro'},]

        debugger;
        //pega os dados armazendos na localstorage e converte usando o JSON.parse
        const selectFieldOptions2 = JSON.parse(localStorage.getItem('item')) 
        
        // cria os elementos básicos da tabela
        const tableWrapper = document.getElementById('tableWrapper')
        // cria o elemento <table> e o elemmento <tbody>
        const table = document.createElement('table') //<table>
        table.setAttribute('id', 'tabelaHeader')
        const tableBody = document.createElement('tbody') //<tbody>

        // cria o primeiro Table Row que é fixo pois só contem ID, Nome, cpf, data nasc, sexo, endereço e cidade
        const header = document.createElement('tr') //cria as linhas da table
        header.setAttribute('id', 'header')

        // o método que gera toda a tabela
        function generateTable() {
            // aqui ele cria os Table Headers estáticos e coloca dentro do Table row acima
            thArray.forEach(item => {
                // cria cada <th> células cabeçalho ex: id, nome, sexo...
                const th = document.createElement('th')
                // adiciona a classe em cada um deles 
                th.setAttribute('class', `${item.class}`)
                // faz a "escrita" dentro dele ex: Nome, id, endereço ... 
                th.innerHTML = item.label

                // adiciona o <th> no header
                header.appendChild(th)
            })
            // coloca o cabeçalho dentro do table body
            tableBody.appendChild(header)

            // chama o método que gera as linhas da tabela
            generateRows()

            // coloca o <tbody> dentro de <table>
            table.appendChild(tableBody)
            // coloca a <table> dentro do <body>
            document.body.appendChild(table)
            // coloca tudo dentro da div #tableWrapper
            tableWrapper.appendChild(table)
        }

        function deleteRows() { //função criada para o funcionamento do botão "excluir"
            trArray.forEach(item => { 
                const element = document.getElementById(`${item.id}`) 
                // na primeira chamada não vão existir elementos ainda, então cancela a execução se for o caso
                if (!element) return
                element.remove() // remove o elemento deixado apenas o id para que não duplique.
            })
        }

        function generateRows() {
            // aqui ele faz os dados dinamicos ou seja, os outros TR -> TD
            trArray.forEach(item => {
                // cria cada o elemento <tr>
                const tr = document.createElement('tr')
                tr.setAttribute('id', item.id)
                // adiciona o evento onclick pra selecionar o item
                tr.onclick = function () {
                    selectItem(tr) //função para poder selecionar o item da tabela e executar alguma ação (excluir ou alterar)
                }
                // aqui é mais complexo, Object.keys, faz com que cada objeto dentro do array "tr"
                // "simule outro array", assim podendo fazer um loop (forEach) em todos eles
                Object.keys(item).forEach((key) => {
                    // cria cada o elemento <td>
                    const td = document.createElement('td')
                    // coloca o label do item dentro do innerhtml do <td>
                    td.innerHTML = item[key]
                    // coloca o <tr> dentro do <td>
                    tr.appendChild(td)

                })
                // novamente, coloca cada tr dentro do table body
                tableBody.appendChild(tr)
            })


            // coloca o <tbody> dentro de <table>
            table.appendChild(tableBody)
            // coloca a <table> dentro do <body>
            document.body.appendChild(table)
            // coloca tudo dentro da div #tableWrapper
            tableWrapper.appendChild(table)
        }

        // invoca o método que cria a table inicial
        generateTable()

        function generateSelectFieldOptions() {
            // pega o field select pelo ID
            const selectField = document.getElementById('field_sexo')
            // faz um loop no array "selectFieldOptions" e cria cada item do select
            selectFieldOptions.forEach((item, i) => {
                // coloca a "new Option()" ou seja, nova opção de select, dentro da
                // posição "i" do array, ou seja, sempre depois da ultima
                selectField.options[i] = new Option(`${item.label}`, `${item.value}`)
            })
        }

        function generateSelectFieldOptions2() {

        const selectField2 = document.getElementById('field_cidade')

        //passa os dados da localstorage pro select de cidade no cadastro do cliente
        selectFieldOptions2.forEach((item, i) => { //faz um loop nos itens armazenados na localstorage
            var el = document.createElement("option"); //cria o elemento "option" que puxa os itens dentro do select
            el.textContent = item.nome; // verifica o nome das cidades armazenadas com item.nome para não haver undefined
            el.value = item.nome; // verifica o valor que foi armazenado das cidades na localstorage
            selectField2.appendChild(el); //insere o conteúdo com o comando appendChill(el) dentro da variável el
        })
        }

        // invoca o método que cria o field select
        generateSelectFieldOptions()

        generateSelectFieldOptions2()

        // método responsável pela inserção de valores na tabela
        function insertItem() {
            alert('Deseja salvar os dados?') //aviso executado antes do item ser inserido para confirmar a ação do usuário

            const fieldNome = document.getElementById('field_nome') //coleta os dados inseridos no campo nome
            const fieldCpf = document.getElementById('field_cpf') // coleta os dados inseridos no campo cpf
            const fieldData = document.getElementById('field_data') //coleta os dados inseridos no campo data nasc
            const fieldSexo = document.getElementById('field_sexo') //coleta os dados inseridos no campo sexo
            const fieldEndereco = document.getElementById('field_endereco') //coleta os dados inseridos no campo de endereço
            const fieldCidade = document.getElementById('field_cidade') //coleta os dados selecionados (select) no campo de cidade
            

            // caso algum dos campos não tenha sido preenchido, calcula a execução do método
            if (!fieldNome.value || !fieldCpf.value || !fieldData.value || !fieldSexo.value || !fieldCidade.value) return
            // incrementa o id que vai ser atribuido ao item
            newId = newId + 1

            // chama o método que deleta os itens cadastrados previamente, para atualizar a tabela e não duplicar
            deleteRows()

            // insere no array
            trArray.push({ id: newId, nome: fieldNome.value, cpf: fieldCpf.value, data: fieldData.value, sexo: fieldSexo.value, endereco: fieldEndereco.value, cidade: fieldCidade.value })
            // chama array de gerar rows
            generateRows()

            document.getElementById('field_id').value=""; // Limpa o campo id
            document.getElementById('field_nome').value=''; // Limpa o campo nome
            document.getElementById('field_cpf').value=''; // Limpa o campo cpf
            document.getElementById('field_data').value=''; // Limpa o campo data
            document.getElementById('field_sexo').value=''; // Limpa o campo sexo
            document.getElementById('field_endereco').value=''; // Limpa o campo endereco
            document.getElementById('field_cidade').value=''; // Limpa o campo cidade
            
        }

        function updateItem() {
            const fieldNome = document.getElementById('field_nome') //atualiza os dados conforme alteradas as informações dos campos
            const fieldCpf = document.getElementById('field_cpf')
            const fieldData = document.getElementById('field_data')
            const fieldSexo = document.getElementById('field_sexo')
            const fieldEndereco = document.getElementById('field_endereco')
            const fieldCidade = document.getElementById('field_cidade')


            // caso algum dos campos não tenha sido preenchido, cancela a execução do método
            if (!selectedItem || !fieldNome.value || !fieldCpf.value || !fieldData.value || !fieldSexo.value || !fieldEndereco.value || !fieldCidade.value) return
            // chama o método que deleta os itens cadastrados previamente, para atualizar a tabela e não duplicar
            deleteRows()

            const itemToUpdate = trArray.find(item => item.id === parseInt(selectedItem, 10))

            if (!itemToUpdate) return
            trArray = trArray.filter(item => item.id !== parseInt(selectedItem, 10))
            trArray.push({ id: itemToUpdate.id, nome: fieldNome.value, cpf: fieldCpf.value, data: fieldData.value, sexo: fieldSexo.value, endereco: fieldEndereco.value, cidade: fieldCidade.value })
            // chama array de gerar rows
            generateRows()
        }

        function deleteItem() {
            alert('Confirma a exclusão do registro selecionado?') //alerta para confirmação de exclusão do item selecionado

            if (!selectedItem) return
            // chama o método que deleta os itens cadastrados previamente, para atualizar a tabela e não duplicar
            deleteRows()

            // filtra o array, mantém apenas itens com id diferente de selectedItem
            trArray = trArray.filter(item => item.id !== parseInt(selectedItem, 10))
            console.log('🚀 ~ file: cadastroCidade.html ~ line 238 ~ trArray filter', trArray)

            // chama gerar rows
            generateRows()
        }

        function selectItem(event) {
            selectedItem = event.id
            // adiciona a classe "selected" no item que foi selecionado
            document.getElementById(selectedItem).classList.add('selected')

            trArray.forEach((item, i) => {
                const element = document.getElementById(`${i}`)
                // verificar se o elemento existe e se o id bate com o item
                if (!element || element.id === selectedItem) return
                element.classList.remove('selected')
            })
        }

        //função responsável pelo filtro que busca pelo nome dos clientes e oculta os que não correspondem conforme a digitação
        $("#search").keyup(function() {
        var value = this.value.toLowerCase().trim();

        $("table tr").each(function(index) {
        if (!index) return;
        $(this).find("td").each(function() {
        var id = $(this).text().toLowerCase().trim();
        var not_found = (id.indexOf(value) == -1);
        $(this).closest('tr').toggle(!not_found);
        return not_found;
        });
    });
});
        $("#tabelaDados tbody tr").click(function() {
            // recupera os valores das células da linha clicada
            var id = $(this).find("td.table_id").text();
            var nome = $(this).find("td.table_nome").text();
            var cpf = $(this).find("td.table_cpf").text();
            // etc...

            // coloca os valores nos inputs correspondentes
        $("#field_id").val(id);
        $("#field_nome").val(nome);
        $("#field_cpf").val(cpf);
            // etc...
});
    // Obter a referência da tabela e dos inputs
    const tabela = document.getElementById('tabelaDados');
    const input1 = document.getElementById('field_nome');
    const input2 = document.getElementById('field_cpf');
    const input3 = document.getElementById('field_endereco');

    // Adicionar evento de clique em cada linha da tabela
    tabela.addEventListener('click', function(event) {
    // Verificar se o clique ocorreu em uma célula da tabela
    const cell = event.target;
    if (cell.tagName === 'TD') {
    // Obter os valores da linha clicada
    const row = cell.parentNode;
    const value1 = row.querySelector('td:nth-child(1)').textContent;
    const value2 = row.querySelector('td:nth-child(2)').textContent;
    const value3 = row.querySelector('td:nth-child(3)').textContent;
    // Preencher os inputs com os valores obtidos
    input1.value = value1;
    input2.value = value2;
    input3.value = value3;
  }
});
    </script>
</body>

</html>
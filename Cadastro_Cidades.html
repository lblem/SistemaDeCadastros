<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="StyleCadastroCidades.css" />
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3803/3803965.png ">
    <title>Cadastro de Cidade</title>
    <!-- <script src="scripts.js"></script> -->
</head>

<body>
    <div id="area">
        <form id="cadastro" autocomplete="off">
            <fieldset>
                <img class="gnc_img" src="https://cdn-icons-png.flaticon.com/512/3803/3803965.png">
                <legend>Cadastro de Cidades</legend>
                <label class="labelRequiered">* Id:</label>

                <input id="field_id" class="campo_id" type="text" name="Id"><br /><br>
                <label class="labelRequiered">* Nome:</label>

                <input id="field_nome" class="campo_nome" type="text" name="nome"><br><br>
                <label class="labelRequiered">* UF:</label>

                <select id="field_uf" class="campo_uf" name="uf">
                </select><br><br>

                <button type="button" class="btn inserir" id="btnAddLine"  onclick="insertItem()">Inserir</button>
                <button type="button" onclick="updateItem()">Alterar</button>
                <button type="button" class="btn excluir" onclick="deleteItem()">Excluir</button>
                <a type="button" href="HomePage.html">Cancelar</a>
                <button id="apagar-local-storage" onclick="excluirCidades()">Apagar Cidades</button>
                <br>
                <br>
                <br>

                <section id="tableWrapper"> <!--Cabeçalho da tabela, referenciado pro script entender onde inicia a tabela-->
                </section>

                <table id="tabelaDados">
                    <thead>
                    <tr>
                            <th><input class="filtro_table" placeholder="Buscar cidade pelo nome" type="text" id="search"/></th> <!--caixa para filtrar dados da tabela-->
                    </tr>    
                    </thead>
                </table>
            </fieldset>
        </form>
    </div>

    <script>
        let newId = 0 //inicio da contagem do id, nesse caso é 0 pois como na documentação inicia a contagem em 1, se deixar 1 com o auto incremento ele puxa 2
        let selectedItem = undefined
        // array com os TD's estáticos
        const thArray = [{ class: 'table_id', label: 'Id' }, { class: 'table_nome', label: 'Nome' }, { class: 'table_uf', label: 'UF' }]
        // esses dados serão dinamicos, inseridos pelo usuário nos campos de id, nome e a UF
        let trArray = []
        // array das opções do field select de UF
        const selectFieldOptions = [
            { value: 'AC', label: 'AC' },
            { value: 'AL', label: 'AL' },
            { value: 'AP', label: 'AP' },
            { value: 'AM', label: 'AM' },
            { value: 'BA', label: 'BA' },
            { value: 'CE', label: 'CE' },
            { value: 'DF', label: 'DF' },
            { value: 'ES', label: 'ES' },
            { value: 'GO', label: 'GO' },
            { value: 'MA', label: 'MA' },
            { value: 'MT', label: 'MT' },
            { value: 'MS', label: 'MS' },
            { value: 'MG', label: 'MG' },
            { value: 'PA', label: 'PA' },
            { value: 'PB', label: 'PB' },
            { value: 'PR', label: 'PR' },
            { value: 'PE', label: 'PE' },
            { value: 'PI', label: 'PI' },
            { value: 'RJ', label: 'RJ' },
            { value: 'RN', label: 'RN' },
            { value: 'RS', label: 'RS' },
            { value: 'RO', label: 'RO' },
            { value: 'RR', label: 'RR' },
            { value: 'SC', label: 'SC' },
            { value: 'SP', label: 'SP' },
            { value: 'SE', label: 'SE' },
            { value: 'TO', label: 'TO' }]

        // cria os elementos básicos da tabela
        const tableWrapper = document.getElementById('tableWrapper')
        // cria o elemento <table> e o elemmento <tbody>
        const table = document.createElement('table')
        table.setAttribute('id', 'tabelaHeader')
        const tableBody = document.createElement('tbody')

        // cria o primeiro Table Row que é fixo pois só contem ID, Nome, UF
        const header = document.createElement('tr')
        header.setAttribute('id', 'header')

        // o método que gera toda a tabela
        function generateTable() {
            // aqui ele cria os Table Headers estáticos e coloca dentro do Table row acima
            thArray.forEach(item => {
                // cria cada <th>
                const th = document.createElement('th')
                // adiciona a classe em cada um deles
                th.setAttribute('class', `${item.class}`)
                // faz a "escrita" dentro dele ex: Nome, id, UF
                th.innerHTML = item.label

                // adiciona o <th> no header
                header.appendChild(th)
            })
            // coloca o cabeçalho dentro do table body
            tableBody.appendChild(header)

            // chama o método que gera as linhas da tabela
            generateRows()

            // coloca o <tbody> dentro de <table>
            table.appendChild(tableBody)
            // coloca a <table> dentro do <body>
            document.body.appendChild(table)
            // coloca tudo dentro da div #tableWrapper
            tableWrapper.appendChild(table)
        }

        function deleteRows() {
            trArray.forEach(item => {
                const element = document.getElementById(`${item.id}`)
                // na primeira chamada não vão existir elementos ainda, então cancela a execução se for o caso
                if (!element) return
                element.remove()
            })
        }

        function generateRows() {
            // aqui ele faz os dados dinamicos ou seja, os outros TR -> TD
            trArray.forEach(item => {
                // cria cada o elemento <tr>
                const tr = document.createElement('tr')
                tr.setAttribute('id', item.id)
                // adiciona o evento onclick pra selecionar o item
                tr.onclick = function () {
                    selectItem(tr)
                }
                // aqui é mais complexo, Object.keys, faz com que cada objeto dentro do array "tr"
                // "simule outro array", assim podendo fazer um loop (forEach) em todos eles
                Object.keys(item).forEach((key) => {
                    // cria cada o elemento <td>
                    const td = document.createElement('td')
                    // coloca o label do item dentro do innerhtml do <td>
                    td.innerHTML = item[key]
                    // coloca o <tr> dentro do <td>
                    tr.appendChild(td)

                })
                // novamente, coloca cada tr dentro do table body
                tableBody.appendChild(tr)
            })


            // coloca o <tbody> dentro de <table>
            table.appendChild(tableBody)
            // coloca a <table> dentro do <body>
            document.body.appendChild(table)
            // coloca tudo dentro da div #tableWrapper
            tableWrapper.appendChild(table)
        }

        // invoca o método que cria a table inicial
        generateTable()

        function generateSelectFieldOptions() {
            // pega o field select pelo ID
            const selectField = document.getElementById('field_uf')
            // faz um loop no array "selectFieldOptions" e cria cada item do select
            selectFieldOptions.forEach((item, i) => {
                // coloca a "new Option()" ou seja, nova opção de select, dentro da
                // posição "i" do array, ou seja, sempre depois da ultima
                selectField.options[i] = new Option(`${item.label}`, `${item.value}`)
            })
        }

        // invoca o método que cria o field select
        generateSelectFieldOptions()

        // método responsável pela inserção de valores na tabela
        function insertItem() {

            alert('Deseja salvar os dados?') //Mensagem de confirmação para salvar dados na tabela

            const nome = $('input[name=nome]').val() //função responsável por selecionar o local onde serão enviados os dados da localstorage

            const dataObj = { nome };

            if(localStorage.getItem('item') === null){

                localStorage.setItem('item', JSON.stringify([dataObj]))
            } else {
                localStorage.setItem(
                    'item', 
                    JSON.stringify([
                        ...JSON.parse(localStorage.getItem('item')),
                        dataObj
                    ])
                )
            }

            const fieldNome = document.getElementById('field_nome') //coleta os dados inseridos no campo de "nome"
            const fieldUf = document.getElementById('field_uf') //coleta os dados inseridos no campo de "UF"

            // caso algum dos campos não tenha sido preenchido, calcula a execução do método
            if (!fieldNome.value || !fieldUf.value) return
            // incrementa o id que vai ser atribuido ao item
            newId = newId + 1

            // chama o método que deleta os itens cadastrados previamente, para atualizar a tabela e não duplicar
            deleteRows()

            // insere no array
            trArray.push({ id: newId, nome: fieldNome.value, uf: fieldUf.value })
            // chama array de gerar rows
            generateRows()

            document.getElementById('field_nome').value=''; // Limpa o campo nome
            document.getElementById('field_uf').value=''; // Limpa o campo
        }


        function updateItem() {
            const fieldNome = document.getElementById('field_nome')
            const fieldUf = document.getElementById('field_uf')

            // caso algum dos campos não tenha sido preenchido, cancela a execução do método
            if (!selectedItem || !fieldNome.value || !fieldUf.value) return
            // chama o método que deleta os itens cadastrados previamente, para atualizar a tabela e não duplicar
            deleteRows()

            const itemToUpdate = trArray.find(item => item.id === parseInt(selectedItem, 10))

            if (!itemToUpdate) return
            trArray = trArray.filter(item => item.id !== parseInt(selectedItem, 10))
            trArray.push({ id: itemToUpdate.id, nome: fieldNome.value, uf: fieldUf.value })
            // chama array de gerar rows
            generateRows()
        }

        function deleteItem() {

            funcao1();  
            
           // alert('Confirma a exclusão do registro selecionado?') //alerta para confirmar a exclusão do item selecionado

            if (!selectedItem) return
            // chama o método que deleta os itens cadastrados previamente, para atualizar a tabela e não duplicar
            deleteRows()

            // filtra o array, mantém apenas itens com id diferente de selectedItem
            trArray = trArray.filter(item => item.id !== parseInt(selectedItem, 10))
            console.log('🚀 ~ file: cadastroCidade.html ~ line 238 ~ trArray filter', trArray)

            // chama gerar rows
            generateRows()
        }

        function deleteItem2() {

           // alert('Confirma a exclusão do registro selecionado?') //alerta para confirmar a exclusão do item selecionado

            if (!selectedItem) return
            // chama o método que deleta os itens cadastrados previamente, para atualizar a tabela e não duplicar
            deleteRows()

            // filtra o array, mantém apenas itens com id diferente de selectedItem
            trArray = trArray.filter(item => item.id !== parseInt(selectedItem, 10))
            console.log('🚀 ~ file: cadastroCidade.html ~ line 238 ~ trArray filter', trArray)

            // chama gerar rows
            generateRows()
        }

        function funcao1()
            {
                var x;
                var r=confirm("Você deseja excluir o item selecionado?");
                if (r==true)
            {
                x= deleteItem2();
            }
                else
            {
                x="Item não excluído!";
            }
                document.getElementById("demo").innerHTML=x;
            }


        function selectItem(event) {
            selectedItem = event.id
            // adiciona a classe "selected" no item que foi selecionado
            document.getElementById(selectedItem).classList.add('selected')

            trArray.forEach((item, i) => {
                const element = document.getElementById(`${i}`)
                // verificar se o elemento existe e se o id bate com o item
                if (!element || element.id === selectedItem) return
                element.classList.remove('selected')
            })
        }

        //função responsável pelo filtro de busca pelo nome da cidade
        $("#search").keyup(function() {
        var value = this.value.toLowerCase().trim();

        $("table tr").each(function(index) {
        if (!index) return;
        $(this).find("td").each(function() {
        var id = $(this).text().toLowerCase().trim();
        var not_found = (id.indexOf(value) == -1);
        $(this).closest('tr').toggle(!not_found);
        return not_found;
        });
        // Obtém o botão por seu ID
        var btnApagarLocalStorage = document.getElementById("apagar-local-storage");

        // Adiciona um ouvinte de eventos de clique ao botão
        btnApagarLocalStorage.addEventListener("click", function() {
        // Apaga todos os dados armazenados na Local Storage
        localStorage.clear();
        });
        function excluirCidades() {
  if (confirm("Tem certeza que deseja EXCLUIR TODAS as cidades cadastradas?")) {
    localStorage.clear();
  } else {
    // Se o usuário cancelar a exclusão, não faça nada.
  }
}
    });
});

</script>
</body>

</html>